<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Contact – TendOn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Contact TendOn for inquiries and support." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- Noto Sans JP -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/common.css" />

  <style>
    :root{
      /* ===== Color===== */
      --bg: #fbfcff;
      --bg2:#f4f7ff;

      --surface: rgba(255,255,255,0.92);
      --text:#0f0f10;
      --text-sub: rgba(15,15,16,0.62);
      --text-faint: rgba(15,15,16,0.48);
      --line: rgba(15,15,16,0.10);

      --accent-blue:#2b6cff;
      --accent-yellow:#f3b700;
      --accent-red:#ff4b4b;

      /* ===== Radius / Shadow ===== */
      --radius: 18px;
      --shadow-xs: 0 10px 28px rgba(0,0,0,0.05);
      --shadow-sm: 0 14px 38px rgba(0,0,0,0.07);

      /* ===== Layout ===== */
      --container: 820px;
      --pageY: 72px;
      --pageX: 22px;

      /* ===== Typography ===== */
      --font:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",sans-serif;
      --h1: 32px;
      --h1-lh: 1.2;

      /* ===== Card ===== */
      --cardPadY: 20px;
      --cardPadX: 20px;

      /* ===== Form ===== */
      --btnH: 44px;
    }

    /* ===== Hero ===== */
    .hero{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom: 44px;
      flex-wrap: wrap;
    }

    .app-icon{
      width: 56px;
      height: 56px;
      aspect-ratio: 1 / 1;
      object-fit: contain;
      object-position: center;
      display:block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.08));
      user-select:none;
      -webkit-user-drag:none;
    }

    h1{
      font-size: var(--h1);
      line-height: var(--h1-lh);
      font-weight: 700;
      margin: 0;
      letter-spacing: .02em;
    }

    .subtitle-wrap{ margin-top: 8px; }
    .subtitle-jp{
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      margin: 0;
      color: rgba(15,15,16,0.86);
      line-height: 1.6;
    }
    .subtitle-en{
      font-size: 12.5px;
      font-weight: 500;
      letter-spacing: 0.02em;
      margin: 6px 0 0;
      color: var(--text-sub);
      line-height: 1.6;
    }

    /* ===== Card ===== */
    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: var(--shadow-xs);
      padding: var(--cardPadY) var(--cardPadX);
    }

    /* ===== Form ===== */
    label{
      display:block;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .14em;
      margin: 16px 0 6px;
      color: rgba(15,15,16,0.78);
    }

    input, textarea{
      width: 100%;
      border: 1px solid rgba(15,15,16,0.12);
      border-radius: 12px;
      padding: 12px;
      font: inherit;
      font-size: 14px;
      color: var(--text);
      background: rgba(255,255,255,0.90);
      outline: none;
      transition: border-color .16s ease, box-shadow .16s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(43,108,255,0.25);
      box-shadow: 0 0 0 4px rgba(43,108,255,0.08);
    }
    textarea{ min-height: 140px; resize: vertical; }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .btn{
      height: var(--btnH);
      padding: 0 16px;
      border-radius: 12px;
      border: 1px solid rgba(15,15,16,0.10);
      background: #111;
      color:#fff;
      font-weight: 700;
      letter-spacing: .02em;
      cursor: pointer;
      transition: transform .18s ease, opacity .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .hp-wrap{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

    @media (max-width: 640px){
      :root{
        --pageY: 56px;
        --pageX: 18px;
        --h1: 28px;
      }
      .hero{ margin-bottom: 36px; }
      .app-icon{ width: 52px; height: 52px; }

      footer{
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    /* ===== Toast (popup) ===== */
    .toast{
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      width: min(520px, calc(100% - 28px));
      z-index: 9999;
      border: 1px solid rgba(15,15,16,0.10);
      border-radius: 14px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      padding: 12px 14px;
      display: none;
    }
    .toast.show{ display:block; animation: toastIn .18s ease-out both; }
    @keyframes toastIn{
      from{ opacity:0; transform:translate(-50%, -6px); }
      to{ opacity:1; transform:translate(-50%, 0); }
    }
    .toast-title{ font-size:13px; font-weight:700; letter-spacing:.02em; margin:0; line-height:1.4; }
    .toast-msg{ font-size:12px; opacity:.72; margin:4px 0 0; line-height:1.5; }

    @media (prefers-reduced-motion: reduce){
      .container{ animation:none; }
      .btn, .back, .footer-link{ transition:none; }
    }
  </style>
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-clear.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-clear.png" />
  <link rel="apple-touch-icon" href="assets/favicon-clear.png" />
</head>
<body>
  <!-- Toast only -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <p class="toast-title" id="toastTitle"></p>
    <p class="toast-msg" id="toastMsg"></p>
  </div>

  <div class="container">
    <header class="hero">
      <img class="app-icon" src="assets/red-clear.png" alt="TendOn Contact" decoding="async">
      <div>
        <h1>Contact</h1>
        <div class="subtitle-wrap">
          <p class="subtitle-jp">お問い合わせ・サポートは、下記フォームよりお願いいたします。</p>
          <p class="subtitle-en">For inquiries and support, please use the form below.</p>
        </div>
      </div>
    </header>

    <div class="card">
      <form id="contactForm" novalidate>
        <label for="name">NAME</label>
        <input id="name" name="name" type="text" autocomplete="name" required>

        <label for="email">EMAIL</label>
        <input id="email" name="email" type="email" autocomplete="email" required>

        <label for="subject">SUBJECT</label>
        <input id="subject" name="subject" type="text" required>

        <label for="message">MESSAGE</label>
        <textarea id="message" name="message" required></textarea>

        <!-- token -->
        <input type="hidden" id="token" name="token" value="">

        <!-- meta -->
        <input type="hidden" id="page" name="page" value="">
        <input type="hidden" id="ua" name="ua" value="">
        <input type="hidden" id="ts" name="ts" value="">

        <!-- honeypot -->
        <div class="hp-wrap" aria-hidden="true">
          <label for="company">Company</label>
          <input id="company" name="company" type="text" tabindex="-1" autocomplete="off">
        </div>

        <div class="actions">
          <button class="btn" id="sendBtn" type="submit" disabled>Send</button>
        </div>
      </form>
    </div>

    <a class="back" href="index.html" aria-label="Back to Home">← Back to Home</a>

    <footer>
      <a class="footer-link" href="privacy.html" aria-label="Open privacy policy">プライバシーポリシー</a>
      <span>© TendOn</span>
    </footer>
  </div>

  <script>
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzfULprP6DZkCB-W3HHxd2oO3mgQGpYD1lfUJ25k1BZTwVvnZQWjZk37XxLvI56Z17ftw/exec";

    // ===== elements =====
    const form = document.getElementById("contactForm");
    const sendBtn = document.getElementById("sendBtn");
    const fields = {
      name: document.getElementById("name"),
      email: document.getElementById("email"),
      subject: document.getElementById("subject"),
      message: document.getElementById("message"),
      token: document.getElementById("token"),
      page: document.getElementById("page"),
      ua: document.getElementById("ua"),
      ts: document.getElementById("ts"),
    };

    const toastEl = document.getElementById("toast");
    const toastTitleEl = document.getElementById("toastTitle");
    const toastMsgEl = document.getElementById("toastMsg");

    function fillMeta(){
      fields.page.value = location.href;
      fields.ua.value = navigator.userAgent;
      fields.ts.value = new Date().toISOString();
    }
    fillMeta();

    function showToast(title, msg){
      toastTitleEl.textContent = title || "";
      toastMsgEl.textContent = msg || "";
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 2600);
    }

    // ===========================
    // Email validation (front)
    // ===========================
    function isValidEmailStrict(email){
      const e = String(email || "").trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return false;

      const lower = e.toLowerCase();
      const domain = lower.split("@")[1] || "";

      const blockedDomains = new Set([
        "example.com", "example.net", "example.org",
        "test.com", "test.jp", "mailinator.com"
      ]);
      if (blockedDomains.has(domain)) return false;

      if (lower === "saisai@example.com") return false;

      return true;
    }

    function validateForm(){
      const name = fields.name.value.trim();
      const email = fields.email.value.trim();
      const subject = fields.subject.value.trim();
      const message = fields.message.value.trim();

      if (!name || !email || !subject || !message) {
        return { ok:false, msg:"未入力の項目があります。" };
      }
      if (!isValidEmailStrict(email)) {
        return { ok:false, msg:"有効なメールアドレスを入力してください。" };
      }
      if (!fields.token.value) {
        return { ok:false, msg:"トークン取得中です。数秒待ってから再度お試しください。" };
      }
      return { ok:true };
    }

    // ===========================
    // Token (JSON endpoint)
    // ===========================
    async function fetchToken(){
      try{
        sendBtn.disabled = true;

        const res = await fetch(GAS_EXEC_URL + "?action=token&v=" + Date.now(), {
          cache: "no-store",
          credentials: "omit"
        });
        if (!res.ok) throw new Error("token request failed");

        const data = await res.json();
        if (!data || !data.token) throw new Error("token missing");

        fields.token.value = String(data.token);
        sendBtn.disabled = false;

      }catch(e){
        sendBtn.disabled = true;
        showToast("送信できません", "トークン取得に失敗しました。時間をおいて再度お試しください。");
      }
    }

    async function parseSubmitResult(res){
      const contentType = String(res.headers.get("content-type") || "").toLowerCase();

      if (contentType.includes("application/json")) {
        return res.json().catch(() => ({ ok:false, error:"INVALID_JSON" }));
      }

      const html = await res.text();
      const hasErrorInHtml = /送信に失敗しました|Error:/u.test(html);
      const redirectedToThanks = res.redirected && String(res.url || "").includes("action=thanks");
      const thanksInHtml = /送信しました|Message sent successfully|お問い合わせありがとうございます/u.test(html);

      if (hasErrorInHtml) {
        return { ok:false, error:"HTML_ERROR" };
      }
      if (redirectedToThanks || thanksInHtml) {
        return { ok:true, mode:"html" };
      }
      if (res.redirected) {
        return { ok:true, mode:"redirect" };
      }

      return { ok:false, error:"NON_JSON_RESPONSE" };
    }

    // ===========================
    // Submit via fetch (no redirect)
    // ===========================
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      const v = validateForm();
      if (!v.ok) {
        showToast("送信できません", v.msg);
        return;
      }

      try{
        sendBtn.disabled = true;

        const fd = new FormData(form);
        fd.append("_mode", "json");
        fd.append("mode", "json");
        const submitUrl = GAS_EXEC_URL + "?_mode=json&mode=json";

        const res = await fetch(submitUrl, {
          method: "POST",
          body: new URLSearchParams(fd),
          cache: "no-store",
          credentials: "omit"
        });
        if (!res.ok) throw new Error("submit request failed");

        const data = await parseSubmitResult(res);

        if (data && data.ok) {
          showToast("送信完了しました", "お問い合わせありがとうございます。");

          form.reset();
          fillMeta();
          fields.token.value = "";

          await fetchToken();
        } else {
          const reason = (data && data.error) ? String(data.error) : "UNKNOWN";
          showToast("送信失敗しました", "時間をおいて再度お試しください。(" + reason + ")");

          fields.token.value = "";
          await fetchToken();
        }

      }catch(err){
        showToast("送信失敗しました", "ネットワーク状況をご確認ください。");

        fields.token.value = "";
        await fetchToken();
      }
    });

    // start
    fetchToken();
  </script>
</body>
</html>
